<!DOCTYPE html>
<html>
<head>
    <meta charset="gbk" />
    <title>demo</title>
    <style type="text/css">
        body, form, h1, h2, h3, h4, p, img, ul, li, ol, dl, dt, dd, a, span, input, tr, th, td{margin:0;padding:0;}
	    body {font:normal 12px/1.5 "Arial","宋体","Simsun","Tahoma",sans-serif;}
	    li {list-style:none;}
	    img {border:0 none;vertical-align:top;}
	    table {border-collapse:collapse;border-spacing:0;}
        .clear-fix:after {display:block;visibility:hidden;font-size:0;line-height:0;clear:both;content:"";}  
        .clear-fix {zoom:1;}
	    a {color:#000;text-decoration:none;}
	    a:hover {color:#f44;text-decoration:underline;}
        
    </style>
    <script src="http://a.tbcdn.cn/s/kissy/1.3.0/kissy.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.js"></script>
</head>
<body>
    <textarea name="Name" rows="8" cols="40" id="text">hello worle for subscribe</textarea>
    <button id="read1">read1 subscribe</button>
    <button id="read2">read2 subscribe</button>
    <button id="read3">read3 subscribe</button>
    <button id="unread1">read1 unsubscribe</button>
    <button id="unread2">read2 unsubscribe</button>
    <button id="unread3">read3 unsubscribe</button>
    <button id="send">send msg</button>
</body>
<script>
var $ = KISSY.Node.all;
var publisher = {
    //用于存放订阅者
    subscribers : {
        any: []              
    },

    //用于订阅
    subscribe: function(fn, type){
        type = type || 'any';
        if(this.subscribers[type] === 'undefined'){
            this.subscribers[type] = [];
        }
        this.subscribers[type].push(fn);
        this.subscribers[type] = KISSY.unique(this.subscribers[type]);
    },

    //删除订阅
    unsubscribe: function(fn, type){
        this.visitSubscribes('unsubscribe', fn, type);
    },

    //遍历订阅者数组发布执行
    publish: function(publication, type){
        this.visitSubscribes('publish', publication, type);
    },

    visitSubscribes: function(action, arg, type){
        var pubtype = type || 'any',                 
            subscribers = this.subscribers[pubtype],
            i,
            len = subscribers.length;

        for (i = 0; i < len; i++) {
            if(action === 'publish'){
                subscribers[i](arg);
            }else if(subscribers[i] === arg){
                subscribers.splice(i, 1);       
            }
        }
    }
}

function makePublisher(o){
    for (var i in publisher) {
        if(publisher.hasOwnProperty(i) && typeof publisher[i] === 'function'){
            o[i] = publisher[i];    
        }
    }
    o.subscribers = {any: []};
}

var code = {
    coding: function(msg){
        this.publish(msg);        
    }
}
var read1 = {
    readCode: function(msg){
        console.log('read1:'+ msg);
    }
}
var read2 = {
    readCode: function(msg){
        console.log('read2:'+ msg);
    }
}
var read3 = {
    readCode: function(msg){
        console.log('read3:'+ msg);
    }
}

makePublisher(code);
code.subscribe(read1.readCode);
code.subscribe(read2.readCode);
code.subscribe(read3.readCode);

code.coding('hello world for subscribe');
$('#read1').on('click', function(e){
        console.log('click');
    code.subscribe(read1.readCode);        
});
$('#read2').on('click', function(e){
    code.subscribe(read2.readCode);        
});
$('#read3').on('click', function(e){
    code.subscribe(read3.readCode);        
});
$('#unread1').on('click', function(e){
    code.unsubscribe(read1.readCode);        
});
$('#unread2').on('click', function(e){
    code.unsubscribe(read2.readCode);        
});
$('#unread3').on('click', function(e){
    code.unsubscribe(read3.readCode);        
});
$('#send').on('click', function(e){
    var msg = document.getElementById('text').value;
    code.coding(msg);
});
</script>
</html> 
